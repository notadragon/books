    i                                                       i
          “cawp-peerson” — 2020/6/10 — 3:09 — page i — #1

i




        C++ Allocators for the Working
                Programmer




i



    i                                                       i
    i                                                                                                 i
                         “cawp-peerson” — 2020/6/10 — 3:09 — page ii — #2

i




            This is simply a placeholder. Your production team will replace this page with the real
        series page.




i



    i                                                                                                 i
    i                                                                                                 i
                    “cawp-peerson” — 2020/6/10 — 3:09 — page iii — #3

i




             C++ Allocators for the Working
                     Programmer




                                            John Lakos
                                          Joshua Berne




          Boston • Columbus • Indianapolis • New York • San Francisco • Amsterdam • Cape Town
        Dubai • London • Madrid • Milan • Munich • Paris • Montreal • Toronto • Delhi • Mexico City
                    Sao Paulo • Sidney • Hong Kong • Seoul • Singapore • Taipei • Tokyo




i



    i                                                                                                 i
    i                                                                                                                    i
                            “cawp-peerson” — 2020/6/10 — 3:09 — page iv — #4

i




        Many of the designations used by manufacturers and sellers to distinguish their products are claimed as
        trademarks. Where those designations appear in this book, and the publisher was aware of a trademark
        claim, the designations have been printed with initial capital letters or in all capitals.

        The authors and publisher have taken care in the preparation of this book, but make no expressed or
        implied warranty of any kind and assume no responsibility for errors or omissions. No liability is assumed
        for incidental or consequential damages in connection with or arising out of the use of the information or
        programs contained herein.

        For information about buying this title in bulk quantities, or for special sales opportunities (which may in-
        clude electronic versions; custom cover designs; and content particular to your business, training goals, mar-
        keting focus, or branding interests), please contact our corporate sales department at corpsales@pearsoned
        .com or (800) 382-3419.

        For government sales inquiries, please contact governmentsales@pearsoned.com.

        For questions about sales outside the United States, please contact international@pearsoned.com.

        Visit us on the Web: informit.com/aw

        Library of Congress Cataloging-in-Publication Data
        LIBRARY OF CONGRESS CIP DATA WILL GO HERE; MUST BE ALIGNED AS INDI-
        CATED BY LOC
        Copyright © 2016 Pearson Education, Inc.

        All rights reserved. Printed in the United States of America. This publication is protected by copyright, and
        permission must be obtained from the publisher prior to any prohibited reproduction, storage in a retrieval
        system, or transmission in any form or by any means, electronic, mechanical, photocopying, recording,
        or likewise. For information regarding permissions, request forms and the appropriate contacts within the
        Pearson Education Global Rights & Permissions Department, please visit www.pearsoned.com/permissions/.


        ISBN-13: NUMBER HERE
        ISBN-10: NUMBER HERE
        Text printed in the United States on recycled paper at PRINTER INFO HERE.
        First printing, MONTH YEAR




i



    i                                                                                                                    i
    i                                                               i
        “cawp-peerson” — 2020/6/10 — 3:09 — page v — #5

i




         This is John’s dedication to Josh for being so great and
                        writing this book so well.
                                    JL



               This is Josh’s dedication to his wife, child,
             and mother-in-law for being all supportive and
                wonderful. And to steak. Steak is great.
                                  JMB




i



    i                                                               i
    i                                                      i
        “cawp-peerson” — 2020/6/10 — 3:09 — page vi — #6

i




i



    i                                                      i
    i                                                                            i
                      “cawp-peerson” — 2020/6/10 — 3:09 — page vii — #7

i




        Contents

        Foreword                                                            ix

        Preface                                                             xi

        Acknowledgements                                                   xv

        About the Authors                                                 xvii

        Chapter 1 Application Developers                                    1
        1.1 What is an Allocator-Aware Type?                                1
                1.1.1 Defining a PMR Allocator-Aware Type                   1
                1.1.2 std::pmr Collections                                  1
        1.2 Using Allocator-Aware Types                                     1
                1.2.1 How to use a Custom Memory Resource                   1
                1.2.2 How to Choose an Allocator                            1
                1.2.3 Testing Code that Allocates                           1
        1.3 Case Study 1: Unique Value Counting                             1

        Chapter 2 Library Writers                                           2
        2.1 Writing Allocator-Aware Types                                   2
                2.1.1 Aggregating Other Allocator-Aware Types               2
                2.1.2 Doing Allocation                                      2
                2.1.3 Testing Allocator-Aware Types                         2
        2.2 Case Study 3: PMR Optional and Variant                          2

        Chapter 3 Writing Allocators                                        3
        3.1 Implementation                                                  3
                3.1.1 Learning from Global Alocators                        3
                3.1.2 Thread-Unsafe Allocators                              3
                3.1.3 Reuse Free Allocators                                 3
                3.1.4 Wrapping Other Allocators for Utility                 3
        3.2 Benchmarking Allocators                                         3
        3.3 Case Study 4: A Buffered Sequential Allocator                   3

        Chapter 4 Advanced                                                  4
                                                                           vii


i



    i                                                                            i
    i                                                                                     i
                          “cawp-peerson” — 2020/6/10 — 3:09 — page viii — #8

i



        viii                                                                   Contents


        4.1    Modern Hardware                                                       4
        4.2    Effective Benchmarking                                                4
        4.3    Optimizing Large Allocator-Aware Systems                              4
        4.4    Designing Effective Allocator-Aware Architectures                     4

        Bibliography                                                                 5

        Chapter A Other Libraries                                                    7
        A.1 BDE                                                                      7
        A.2 Thrust                                                                   7

        Chapter B Future Developments                                                8
        B.1 More PMR Types                                                           8
        B.2 Automating Allocator Suppoer                                             8




i



    i                                                                                     i
    i                                                                          i
                       “cawp-peerson” — 2020/6/10 — 3:09 — page ix — #9

i




        Foreword
        The text of the foreword will go here.




                                                                          ix


i



    i                                                                          i
    i                                                      i
        “cawp-peerson” — 2020/6/10 — 3:09 — page x — #10

i




i



    i                                                      i
    i                                                                                                   i
                      “cawp-peerson” — 2020/6/10 — 3:09 — page xi — #11

i




        Preface
        The text of the preface will go here. All the elements and commands offered within the text
        will work here as well.
            Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque
        laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi archi-
        tecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit
        aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione volup-
        tatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet,
        consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et
        dolore magnam aliquam quaerat voluptatem. Ut enim ad minima veniam, quis nostrum ex-
        ercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur?
        Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae
        consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?
            At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium
        voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati
        cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est
        laborum et dolorum fuga. Et harum quidem rerum facilis est et expedita distinctio. Nam
        libero tempore, cum soluta nobis est eligendi optio cumque nihil impedit quo minus id quod
        maxime placeat facere possimus, omnis voluptas assumenda est, omnis dolor repellendus.
        Temporibus autem quibusdam et aut officiis debitis aut rerum necessitatibus saepe eveniet
        ut et voluptates repudiandae sint et molestiae non recusandae. Itaque earum rerum hic
        tenetur a sapiente delectus, ut aut reiciendis voluptatibus maiores alias consequatur aut
        perferendis doloribus asperiores repellat.
            Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque
        laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi archi-
        tecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit
        aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione volup-
        tatem sequi nesciunt.Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet,
        consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et
        dolore magnam aliquam quaerat voluptatem. Ut enim ad minima veniam, quis nostrum ex-
        ercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur?
        Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae
        consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?
            At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium
        voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati
        cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est
        laborum et dolorum fuga. Et harum quidem rerum facilis est et expedita distinctio. Nam
        libero tempore, cum soluta nobis est eligendi optio cumque nihil impedit quo minus id quod
        maxime placeat facere possimus, omnis voluptas assumenda est, omnis dolor repellendus.
                                                                                                   xi


i



    i                                                                                                   i
    i                                                                                                   i
                        “cawp-peerson” — 2020/6/10 — 3:09 — page xii — #12

i



        xii                                                                                   Preface


        Temporibus autem quibusdam et aut officiis debitis aut rerum necessitatibus saepe eveniet
        ut et voluptates repudiandae sint et molestiae non recusandae. Itaque earum rerum hic
        tenetur a sapiente delectus, ut aut reiciendis voluptatibus maiores alias consequatur aut
        perferendis doloribus asperiores repellat.
            Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque
        laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi archi-
        tecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit
        aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione volup-
        tatem sequi nesciunt.Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet,
        consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et
        dolore magnam aliquam quaerat voluptatem. Ut enim ad minima veniam, quis nostrum ex-
        ercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur?
        Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae
        consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?
            At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium
        voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati
        cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est
        laborum et dolorum fuga. Et harum quidem rerum facilis est et expedita distinctio. Nam
        libero tempore, cum soluta nobis est eligendi optio cumque nihil impedit quo minus id quod
        maxime placeat facere possimus, omnis voluptas assumenda est, omnis dolor repellendus.
        Temporibus autem quibusdam et aut officiis debitis aut rerum necessitatibus saepe eveniet
        ut et voluptates repudiandae sint et molestiae non recusandae. Itaque earum rerum hic
        tenetur a sapiente delectus, ut aut reiciendis voluptatibus maiores alias consequatur aut
        perferendis doloribus asperiores repellat.
            Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque
        laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi archi-
        tecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit
        aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione volup-
        tatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet,
        consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et
        dolore magnam aliquam quaerat voluptatem. Ut enim ad minima veniam, quis nostrum ex-
        ercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur?
        Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae
        consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?
            At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium
        voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati
        cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est
        laborum et dolorum fuga. Et harum quidem rerum facilis est et expedita distinctio. Nam
        libero tempore, cum soluta nobis est eligendi optio cumque nihil impedit quo minus id quod
        maxime placeat facere possimus, omnis voluptas assumenda est, omnis dolor repellendus.
        Temporibus autem quibusdam et aut officiis debitis aut rerum necessitatibus saepe eveniet
        ut et voluptates repudiandae sint et molestiae non recusandae. Itaque earum rerum hic
        tenetur a sapiente delectus, ut aut reiciendis voluptatibus maiores alias consequatur aut
        perferendis doloribus asperiores repellat.
            Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque




i



    i                                                                                                   i
    i                                                                                                    i
                      “cawp-peerson” — 2020/6/10 — 3:09 — page xiii — #13

i



        Preface                                                                                   xiii


        laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi archi-
        tecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit
        aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione volup-
        tatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet,
        consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et
        dolore magnam aliquam quaerat voluptatem. Ut enim ad minima veniam, quis nostrum ex-
        ercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur?
        Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae
        consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?
            At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium
        voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati
        cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est
        laborum et dolorum fuga. Et harum quidem rerum facilis est et expedita distinctio. Nam
        libero tempore, cum soluta nobis est eligendi optio cumque nihil impedit quo minus id quod
        maxime placeat facere possimus, omnis voluptas assumenda est, omnis dolor repellendus.
        Temporibus autem quibusdam et aut officiis debitis aut rerum necessitatibus saepe eveniet
        ut et voluptates repudiandae sint et molestiae non recusandae. Itaque earum rerum hic
        tenetur a sapiente delectus, ut aut reiciendis voluptatibus maiores alias consequatur aut
        perferendis doloribus asperiores repellat.
            Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque
        laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi archi-
        tecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit
        aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione volup-
        tatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet,
        consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et
        dolore magnam aliquam quaerat voluptatem. Ut enim ad minima veniam, quis nostrum ex-
        ercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur?
        Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae
        consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?
            At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium
        voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati
        cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est
        laborum et dolorum fuga. Et harum quidem rerum facilis est et expedita distinctio. Nam
        libero tempore, cum soluta nobis est eligendi optio cumque nihil impedit quo minus id quod
        maxime placeat facere possimus, omnis voluptas assumenda est, omnis dolor repellendus.
        Temporibus autem quibusdam et aut officiis debitis aut rerum necessitatibus saepe eveniet
        ut et voluptates repudiandae sint et molestiae non recusandae. Itaque earum rerum hic
        tenetur a sapiente delectus, ut aut reiciendis voluptatibus maiores alias consequatur aut
        perferendis doloribus asperiores repellat.




i



    i                                                                                                    i
    i                                                        i
        “cawp-peerson” — 2020/6/10 — 3:09 — page xiv — #14

i




i



    i                                                        i
    i                                                                         i
                     “cawp-peerson” — 2020/6/10 — 3:09 — page xv — #15

i




        Acknowledgements
        The text of the author’s acknowledgements will go here.




                                                                         xv


i



    i                                                                         i
    i                                                        i
        “cawp-peerson” — 2020/6/10 — 3:09 — page xvi — #16

i




i



    i                                                        i
    i                                                                                                   i
                     “cawp-peerson” — 2020/6/10 — 3:09 — page xvii — #17

i




        About the Authors

                                   John Lakos, author of Large-Scale C++ Software Design [Pear-
                                   son, 1996] and Large-Scale C++ — Volume I: Process and Ar-
                                   chitecture [Pearson, 2019], serves at Bloomberg in New York
                                   City as a senior architect and mentor for C++ software devel-
                                   opment worldwide. He is also an active voting member of the
                                   C++ Standards Committee’s Evolution Working Group. From
                                   1997 to 2001, Dr. Lakos directed the design and development
                                   of infrastructure libraries for proprietary analytic financial ap-
                                   plications at Bear Stearns. From 1983 to 1997, Dr. Lakos was
                                   employed at Mentor Graphics, where he developed large frame-
                                   works and advanced ICCAD applications for which he holds mul-
                                   tiple software patents. His academic credentials include a Ph.D.
        in Computer Science (1997) and an Sc.D. in Electrical Engineering (1989) from Columbia
        University. Dr. Lakos received his undergraduate degrees from MIT in Mathematics (1982)
        and Computer Science (1981).


                                    Joshua Berne serves at Bloomberg LP as a senior software engi-
                                    neer on Bloomberg’s core library team. After the difficult choice
                                    to pursue a career in software engineering over research math-
                                    ematics, he has been an active programmer in the financial in-
                                    dustry, writing day trading applications in C++ for E*TRADE
                                    Capital Markets and, after that, architecting large distributed
                                    trading systems in Java for Instinet and IDC. Since joining
                                    Bloomberg in 2017, he has been an active participant in the
                                    C++ Standards Committee, seeking to bring the advancements
                                    made within Bloomberg to the C++ Standard and thus to the
                                    rest of the world. His first WG21 paper was [1]




                                                                                                 xvii


i



    i                                                                                                   i
    i                                                          i
        “cawp-peerson” — 2020/6/10 — 3:09 — page xviii — #18

i




i



    i                                                          i
    i                                                                      i
                    “cawp-peerson” — 2020/6/10 — 3:09 — page 1 — #19

i




        Chapter 1
        Application Developers

        1.1     What is an Allocator-Aware Type?
        1.1.1   Defining a PMR Allocator-Aware Type
        1.1.2   std::pmr Collections

        1.2     Using Allocator-Aware Types
        1.2.1   How to use a Custom Memory Resource
        1.2.2   How to Choose an Allocator
        1.2.3   Testing Code that Allocates

        1.3     Case Study 1: Unique Value Counting




                                                                       1


i



    i                                                                      i
    i                                                                   i
                     “cawp-peerson” — 2020/6/10 — 3:09 — page 2 — #20

i




        Chapter 2
        Library Writers

        2.1     Writing Allocator-Aware Types
        2.1.1   Aggregating Other Allocator-Aware Types
        2.1.2   Doing Allocation
        2.1.3   Testing Allocator-Aware Types

        2.2     Case Study 3: PMR Optional and Variant




        2



i



    i                                                                   i
    i                                                                      i
                    “cawp-peerson” — 2020/6/10 — 3:09 — page 3 — #21

i




        Chapter 3
        Writing Allocators

        3.1     Implementation
        3.1.1   Learning from Global Alocators
        3.1.2   Thread-Unsafe Allocators
        3.1.3   Reuse Free Allocators
        3.1.4   Wrapping Other Allocators for Utility

        3.2     Benchmarking Allocators

        3.3     Case Study 4: A Buﬀered Sequential Allocator




                                                                       3


i



    i                                                                      i
    i                                                                       i
                       “cawp-peerson” — 2020/6/10 — 3:09 — page 4 — #22

i




        Chapter 4
        Advanced

        4.1    Modern Hardware

        4.2    Eﬀective Benchmarking
        Here we would be discussing the approach we have to benchmarking.




        4.3    Optimizing Large Allocator-Aware Systems

        4.4    Designing Eﬀective Allocator-Aware Architectures




        4



i



    i                                                                       i
    i                                                                                           i
                     “cawp-peerson” — 2020/6/10 — 3:09 — page 5 — #23

i




        Bibliography
        [1] Joshua Berne, Nathan Burgers, Hyman Rosen, John Lakos, “Contract checking in c++:
            A (long-term) road map,” Tech. Rep. P1332R0, WG21 - The C++ Standards Commit-
            tee, 2018.




                                                                                           5


i



    i                                                                                           i
    i                                                      i
        “cawp-peerson” — 2020/6/10 — 3:09 — page 6 — #24

i




i



    i                                                      i
    i                                                                   i
                 “cawp-peerson” — 2020/6/10 — 3:09 — page 7 — #25

i




        Appendix A
        Other Libraries

        A.1   BDE

        A.2   Thrust




                                                                    7


i



    i                                                                   i
    i                                                                 i
                   “cawp-peerson” — 2020/6/10 — 3:09 — page 8 — #26

i




        Appendix B
        Future Developments

        B.1   More PMR Types

        B.2   Automating Allocator Suppoer




        8



i



    i                                                                 i
